<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procesador Avanzado de Asistencia</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .input-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 5px solid #667eea;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        textarea {
            min-height: 200px;
            font-family: 'Courier New', monospace;
            resize: vertical;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s;
            width: 100%;
            margin: 10px 0;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        .btn-secondary {
            background: #6c757d;
        }
        .results {
            background: #e8f5e8;
            padding: 25px;
            border-radius: 12px;
            margin-top: 25px;
            border-left: 5px solid #28a745;
        }
        .processed-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            font-size: 10px;
        }
        .processed-table th, .processed-table td {
            padding: 6px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }
        .processed-table th {
            background: #667eea;
            color: white;
            font-weight: bold;
        }
        .processed-table tr:hover {
            background-color: #f5f5f5;
        }
        .late {
            color: #dc3545;
            font-weight: bold;
        }
        .good {
            color: #28a745;
            font-weight: bold;
        }
        .warning {
            color: #fd7e14;
            font-weight: bold;
        }
        .overtime {
            color: #6f42c1;
            font-weight: bold;
        }
        .incomplete {
            color: #e91e63;
            font-weight: bold;
        }
        .saturday {
            background-color: #fff8e1 !important;
        }
        .sunday {
            background-color: #e8f5e8 !important;
        }
        .saturday-indicator {
            background: #ff9800;
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 8px;
            margin-left: 2px;
        }
        .sunday-indicator {
            background: #4caf50;
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 8px;
            margin-left: 2px;
        }
        .employee-name {
            text-align: left;
            font-weight: bold;
            padding-left: 8px;
            min-width: 120px;
        }
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .summary-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .summary-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }
        .summary-label {
            color: #666;
            margin-top: 5px;
            font-size: 0.8em;
        }
        .example-format {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        .scroll-container {
            overflow-x: auto;
            max-height: 600px;
        }
        .parsing-info {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #ffc107;
        }
        .day-header {
            writing-mode: vertical-lr;
            text-orientation: mixed;
            min-width: 25px;
            font-size: 9px;
        }
        .info-note {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 3px solid #2196f3;
            font-size: 12px;
        }
        .employee-config {
            background: #fff3e0;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #ff9800;
        }
        .employee-config h4 {
            margin-top: 0;
            color: #e65100;
        }
        .config-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }
        .config-table th, .config-table td {
            padding: 5px;
            border: 1px solid #ddd;
            text-align: center;
        }
        .config-table th {
            background: #ff9800;
            color: white;
            font-size: 10px;
        }
        .time-cell {
            font-size: 9px;
            line-height: 1.1;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .checkbox-container input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Procesador Avanzado de Asistencia</h1>
        
        <div class="input-section">
            <h3>üìã Datos del Excel</h3>
            
            <div class="example-format">
                <strong>‚úÖ Acepta ambos formatos:</strong><br>
                <strong>Formato 1 (tabla):</strong> Como lo pegas directamente del Excel<br>
                <strong>Formato 2 (lineal):</strong> ID: 1090412874 Nombre: YURLEY ALEXANDRA...
            </div>

            <div class="form-group">
                <label>üî§ Pega aqu√≠ los datos del Excel tal como aparecen:</label>
                <textarea id="rawData" placeholder="Pega aqu√≠ directamente lo que copias del Excel (Ctrl+C, Ctrl+V)"></textarea>
            </div>

            <div class="config-grid">
                <div class="form-group">
                    <label>Tolerancia llegadas (min):</label>
                    <input type="number" id="tolerance" value="10">
                </div>
                <div class="form-group">
                    <label>Almuerzo por defecto (min):</label>
                    <input type="number" id="defaultLunch" value="60">
                </div>
            </div>

            <button class="btn" onclick="processRawData()">üöÄ Procesar Datos</button>
            <button class="btn btn-secondary" onclick="loadExampleData()">üìù Cargar Ejemplo</button>
        </div>

        <div class="employee-config" id="employeeConfig" style="display: none;">
            <h4>üë• Configuraci√≥n Individual de Empleados</h4>
            <p>Ajusta los horarios espec√≠ficos para cada empleado:</p>
            <div id="employeeConfigTable"></div>
            <button class="btn" onclick="recalculateWithConfig()">üîÑ Recalcular con Configuraci√≥n</button>
        </div>

        <div class="parsing-info" id="parsingInfo" style="display: none;">
            <h4>üîç An√°lisis de Datos:</h4>
            <div id="parsingDetails"></div>
        </div>

        <div class="results" id="resultsSection" style="display: none;">
            <h3>üìä Resultados de Asistencia</h3>
            <div class="summary" id="summary"></div>
            
            <div class="scroll-container">
                <table class="processed-table" id="processedTable">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                <button class="btn" onclick="exportToCSV()">üì• Descargar Resumen CSV</button>
                <button class="btn" onclick="exportDetailedReport()">üìã Descargar Informe Completo</button>
            </div>

            <button class="btn" onclick="exportToPDF()">üìÑ Descargar PDF</button>

        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <script>
        let processedEmployees = [];
        let employeeConfigs = {};

        function extractTimes(text) {
            const timeRegex = /\d{2}:\d{2}/g;
            const matches = text.match(timeRegex) || [];
            return matches;
        }

        function cleanEmployeeName(nameStr) {
            let cleaned = nameStr.replace(/\s+/g, ' ').trim();
            cleaned = cleaned.replace(/^[^\w\s]+|[^\w\s]+$/g, '');
            cleaned = cleaned.split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');
            return cleaned || 'Sin nombre';
        }

        function parseTableFormat(rawData) {
            const employees = [];
            const lines = rawData.split('\n').filter(line => line.trim());
            
            let currentEmployee = null;
            
            for (let line of lines) {
                if (line.includes('ID:') && line.includes('Nombre:')) {
                    if (currentEmployee) {
                        employees.push(currentEmployee);
                    }
                    
                    const idMatch = line.match(/ID:\s*(\d+)/);
                    let nameMatch = line.match(/Nombre:\s*([^D]+?)(?:\s*Departamento:|$)/);
                    let name = 'Sin nombre';
                    
                    if (nameMatch) {
                        name = cleanEmployeeName(nameMatch[1]);
                    }
                    
                    const deptMatch = line.match(/Departamento:\s*(.+?)$/);
                    
                    currentEmployee = {
                        id: idMatch ? idMatch[1].trim() : '',
                        name: name,
                        department: deptMatch ? deptMatch[1].trim() : '',
                        allTimes: []
                    };
                } else if (currentEmployee && line.trim()) {
                    const times = extractTimes(line);
                    currentEmployee.allTimes.push(...times);
                }
            }
            
            if (currentEmployee) {
                employees.push(currentEmployee);
            }
            
            return employees;
        }

        function parseLinearFormat(rawData) {
            const lines = rawData.split(/\n+/).filter(line => line.trim() && line.includes('ID:'));
            const employees = [];
            
            lines.forEach(line => {
                const idMatch = line.match(/ID:\s*(\d+)/);
                let nameMatch = line.match(/Nombre:\s*([A-Z\s]+?)(?:\s+Departamento|\s+\d{2}:)/);
                let name = 'Sin nombre';
                
                if (nameMatch) {
                    name = cleanEmployeeName(nameMatch[1]);
                }
                
                const deptMatch = line.match(/Departamento:\s*([^\d]+)/);
                const afterDept = line.split(/Departamento.*?/)[1] || line.split(/Empresa/)[1] || '';
                const allTimes = extractTimes(afterDept);
                
                employees.push({
                    id: idMatch ? idMatch[1] : '',
                    name: name,
                    department: deptMatch ? deptMatch[1].trim() : '',
                    allTimes: allTimes
                });
            });
            
            return employees;
        }

        function isSaturday(times) {
            if (times.length === 0) return false;
            const sorted = times.sort((a, b) => timeToMinutes(a) - timeToMinutes(b));
            const lastTime = sorted[sorted.length - 1];
            const lastHour = parseInt(lastTime.split(':')[0]);
            return lastHour < 14 || (times.length <= 2 && lastHour <= 15);
        }

        function groupTimesByDay(times) {
            const days = [];
            let currentDay = [];
            
            for (let i = 0; i < times.length; i++) {
                const time = times[i];
                const hour = parseInt(time.split(':')[0]);
                
                if (hour <= 8 && currentDay.length > 0) {
                    const lastTime = currentDay[currentDay.length - 1];
                    const lastHour = parseInt(lastTime.split(':')[0]);
                    
                    if (lastHour >= 12 || currentDay.length >= 4 || isSaturday(currentDay)) {
                        days.push([...currentDay]);
                        currentDay = [time];
                    } else {
                        currentDay.push(time);
                    }
                } else {
                    currentDay.push(time);
                }
            }
            
            if (currentDay.length > 0) {
                days.push(currentDay);
            }

            return days;
        }

        function organizeDayTimes(times) {
            if (times.length === 0) return null;

            const isSat = isSaturday(times);
            const sorted = times.sort((a, b) => timeToMinutes(a) - timeToMinutes(b));

            let organized = {
                entry: null,
                lunchStart: null,
                lunchEnd: null,
                afternoonEntry: null,
                exit: null,
                allTimes: sorted,
                isSaturday: isSat,
                isIncomplete: false,
                missingRecords: []
            };

            if (sorted.length >= 1) {
                organized.entry = sorted[0];
                organized.exit = sorted[sorted.length - 1];

                if (!isSat && sorted.length >= 3) {
                    const middleTimes = sorted.slice(1, -1);
                    const lunchTimes = middleTimes.filter(time => {
                        const hour = parseInt(time.split(':')[0]);
                        return hour >= 10 && hour <= 15;
                    });

                    if (lunchTimes.length >= 2) {
                        organized.lunchStart = lunchTimes[0];
                        organized.lunchEnd = lunchTimes[lunchTimes.length - 1];
                        organized.afternoonEntry = organized.lunchEnd;
                    }
                }
            }

            // Detectar registros incompletos
            if (!isSat) {
                if (sorted.length === 1) {
                    organized.isIncomplete = true;
                    organized.missingRecords.push('salida');
                } else if (sorted.length === 2) {
                    // Podr√≠a estar incompleto si trabaja tarde
                    const config = getEmployeeConfig('default');
                    if (config.worksAfternoon) {
                        organized.isIncomplete = true;
                        organized.missingRecords.push('entrada tarde', 'salida tarde');
                    }
                } else if (sorted.length === 3) {
                    organized.isIncomplete = true;
                    organized.missingRecords.push('entrada o salida tarde');
                }
            } else {
                if (sorted.length === 1) {
                    organized.isIncomplete = true;
                    organized.missingRecords.push('salida');
                }
            }

            return organized;
        }

        function timeToMinutes(timeStr) {
            if (!timeStr) return null;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function minutesToTimeString(minutes) {
            if (minutes === null || minutes === undefined || minutes < 0) return '--';
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours}:${mins.toString().padStart(2, '0')}`;
        }

        function getEmployeeConfig(employeeId) {
            if (employeeConfigs[employeeId]) {
                return employeeConfigs[employeeId];
            }
            
            return {
                morningEntry: '06:00',
                morningExit: '12:00',
                afternoonEntry: '14:00',
                afternoonExit: '17:30',
                saturdayEntry: '06:00',
                saturdayExit: '12:00',
                worksAfternoon: true,
                lunchDuration: parseInt(document.getElementById('defaultLunch').value),
                saturdayLunch: 0
            };
        }

        function calculateDayStats(dayData, employeeId) {
            if (!dayData) {
                return {
                    hoursWorked: 0,
                    lateMinutes: 0,
                    earlyExitMinutes: 0,
                    overtimeMinutes: 0,
                    expectedMinutes: 0,
                    status: 'domingo'
                };
            }

            if (!dayData.entry || !dayData.exit) {
                return {
                    hoursWorked: 0,
                    lateMinutes: 0,
                    earlyExitMinutes: 0,
                    overtimeMinutes: 0,
                    expectedMinutes: 0,
                    status: 'incompleto'
                };
            }

            const config = getEmployeeConfig(employeeId);
            const tolerance = parseInt(document.getElementById('tolerance').value);

            let expectedEntry, expectedExit;

            if (dayData.isSaturday) {
                expectedEntry = config.saturdayEntry;
                expectedExit = config.saturdayExit;
            } else {
                expectedEntry = config.morningEntry;
                expectedExit = config.worksAfternoon ? config.afternoonExit : config.morningExit;
            }

            const lunchDuration = dayData.isSaturday ? config.saturdayLunch :
                                (config.worksAfternoon ? config.lunchDuration : 0);

            const entryMin = timeToMinutes(dayData.entry);
            const exitMin = timeToMinutes(dayData.exit);
            const expectedEntryMin = timeToMinutes(expectedEntry);
            const expectedExitMin = timeToMinutes(expectedExit);

            // Tardanza ma√±ana
            let lateMorning = Math.max(0, entryMin - expectedEntryMin - tolerance);

            // Tardanza tarde
            let lateAfternoon = 0;
            if (dayData.afternoonEntry && config.worksAfternoon && !dayData.isSaturday) {
                const expectedAfternoonMin = timeToMinutes(config.afternoonEntry);
                const afternoonEntryMin = timeToMinutes(dayData.afternoonEntry);
                lateAfternoon = Math.max(0, afternoonEntryMin - expectedAfternoonMin - tolerance);
            }

            const lateMinutes = lateMorning + lateAfternoon;

            const earlyExitMinutes = Math.max(0, expectedExitMin - exitMin - tolerance);
            const overtimeMinutes = Math.max(0, exitMin - expectedExitMin - tolerance);

            let totalMinutes = exitMin - entryMin;
            if (dayData.lunchStart && dayData.lunchEnd) {
                const actualLunch = timeToMinutes(dayData.lunchEnd) - timeToMinutes(dayData.lunchStart);
                totalMinutes -= actualLunch;
            } else if (lunchDuration > 0) {
                totalMinutes -= lunchDuration;
            }

            const hoursWorked = Math.max(0, totalMinutes);

            // üîπ Horas esperadas seg√∫n la configuraci√≥n
            let expectedMinutes = 0;
            if (dayData.isSaturday) {
                expectedMinutes = timeToMinutes(config.saturdayExit) - timeToMinutes(config.saturdayEntry);
            } else {
                if (config.worksAfternoon) {
                    expectedMinutes = (timeToMinutes(config.morningExit) - timeToMinutes(config.morningEntry)) +
                                    (timeToMinutes(config.afternoonExit) - timeToMinutes(config.afternoonEntry));
                } else {
                    expectedMinutes = timeToMinutes(config.morningExit) - timeToMinutes(config.morningEntry);
                }
            }

            let status = 'puntual';
            if (dayData.isIncomplete) {
                status = 'incompleto';
            } else if (lateMinutes > 0 && overtimeMinutes > 0) {
                status = 'tarde_extra';
            } else if (lateMinutes > 0 && earlyExitMinutes > 0) {
                status = 'tarde_temprano';
            } else if (lateMinutes > 0) {
                status = 'tarde';
            } else if (earlyExitMinutes > 0) {
                status = 'temprano';
            } else if (overtimeMinutes > 0) {
                status = 'extra';
            }

            return {
                hoursWorked,
                lateMinutes,
                earlyExitMinutes,
                overtimeMinutes,
                expectedMinutes,
                status
            };
        }

        function processRawData() {
            const rawData = document.getElementById('rawData').value.trim();

            if (!rawData) {
                alert('Por favor pega los datos del Excel');
                return;
            }

            let employees = [];
            
            if (rawData.includes('ID:') && rawData.includes('Nombre:') && rawData.includes('Departamento:')) {
                if (rawData.split('\n').some(line => line.includes('ID:') && line.includes('Nombre:') && line.includes('Departamento:'))) {
                    employees = parseTableFormat(rawData);
                } else {
                    employees = parseLinearFormat(rawData);
                }
            } else {
                alert('Formato no reconocido. Aseg√∫rate de incluir ID:, Nombre: y Departamento:');
                return;
            }

            processedEmployees = [];
            let parsingDetails = '<ul>';
            let totalSaturdays = 0;
            let totalSundays = 0;
            let totalIncomplete = 0;

            // Encontrar el n√∫mero m√°ximo de d√≠as trabajados
            const maxDays = Math.max(...employees.map(emp => {
                if (emp.allTimes.length === 0) return 0;
                return groupTimesByDay(emp.allTimes).length;
            }));

            employees.forEach((employeeData) => {
                parsingDetails += `<li><strong>${employeeData.name}</strong> (${employeeData.department}) - ${employeeData.allTimes.length} registros</li>`;
                
                let employee = {
                    id: employeeData.id,
                    name: employeeData.name,
                    department: employeeData.department,
                    days: []
                };

                if (employeeData.allTimes.length > 0) {
                    const dayGroups = groupTimesByDay(employeeData.allTimes);
                    
                    // Procesar d√≠as trabajados
                    dayGroups.forEach((dayTimes, dayIndex) => {
                        const organized = organizeDayTimes(dayTimes);
                        if (organized) {
                            const stats = calculateDayStats(organized, employeeData.id);
                            employee.days.push({
                                dayNumber: dayIndex + 1,
                                organized: organized,
                                stats: stats,
                                isSunday: false
                            });
                            
                            if (organized.isSaturday) totalSaturdays++;
                            if (organized.isIncomplete) totalIncomplete++;
                        }
                    });

                    // Agregar domingos para completar hasta maxDays
                    while (employee.days.length < maxDays) {
                        const dayNumber = employee.days.length + 1;
                        const stats = calculateDayStats(null, employeeData.id);
                        employee.days.push({
                            dayNumber: dayNumber,
                            organized: null,
                            stats: stats,
                            isSunday: true
                        });
                        totalSundays++;
                    }
                } else {
                    // Si no tiene registros, todos son domingos
                    for (let i = 1; i <= maxDays; i++) {
                        const stats = calculateDayStats(null, employeeData.id);
                        employee.days.push({
                            dayNumber: i,
                            organized: null,
                            stats: stats,
                            isSunday: true
                        });
                        totalSundays++;
                    }
                }

                processedEmployees.push(employee);
            });

            parsingDetails += `</ul>
                <div class="info-note">üìä <strong>${totalSaturdays}</strong> d√≠as detectados como s√°bados</div>
                <div class="info-note">üè† <strong>${totalSundays}</strong> d√≠as detectados como domingos</div>
                <div class="info-note">‚ö†Ô∏è <strong>${totalIncomplete}</strong> d√≠as con registros incompletos</div>`;
            
            document.getElementById('parsingDetails').innerHTML = parsingDetails;
            document.getElementById('parsingInfo').style.display = 'block';

            createEmployeeConfig();
            displayResults();
        }

        function createEmployeeConfig() {
            let configHTML = `
                <table class="config-table">
                    <tr>
                        <th>Empleado</th>
                        <th>Entrada<br>Ma√±ana</th>
                        <th>Salida<br>Ma√±ana</th>
                        <th>Entrada<br>Tarde</th>
                        <th>Salida<br>Tarde</th>
                        <th>Trabaja<br>Tarde</th>
                        <th>S√°b<br>Entrada</th>
                        <th>S√°b<br>Salida</th>
                        <th>Almuerzo<br>(min)</th>
                    </tr>
            `;
            
            processedEmployees.forEach(employee => {
                const config = getEmployeeConfig(employee.id);
                configHTML += `
                    <tr>
                        <td style="text-align: left;">${employee.name}</td>
                        <td><input type="time" id="morning_entry_${employee.id}" value="${config.morningEntry}" style="width:70px;font-size:10px;"></td>
                        <td><input type="time" id="morning_exit_${employee.id}" value="${config.morningExit}" style="width:70px;font-size:10px;"></td>
                        <td><input type="time" id="afternoon_entry_${employee.id}" value="${config.afternoonEntry}" style="width:70px;font-size:10px;"></td>
                        <td><input type="time" id="afternoon_exit_${employee.id}" value="${config.afternoonExit}" style="width:70px;font-size:10px;"></td>
                        <td>
                            <div class="checkbox-container">
                                <input type="checkbox" id="works_afternoon_${employee.id}" ${config.worksAfternoon ? 'checked' : ''}>
                            </div>
                        </td>
                        <td><input type="time" id="sat_entry_${employee.id}" value="${config.saturdayEntry}" style="width:70px;font-size:10px;"></td>
                        <td><input type="time" id="sat_exit_${employee.id}" value="${config.saturdayExit}" style="width:70px;font-size:10px;"></td>
                        <td><input type="number" id="lunch_${employee.id}" value="${config.lunchDuration}" style="width:50px;font-size:10px;"></td>
                    </tr>
                `;
            });
            
            configHTML += '</table>';
            document.getElementById('employeeConfigTable').innerHTML = configHTML;
            document.getElementById('employeeConfig').style.display = 'block';
        }

        function recalculateWithConfig() {
            processedEmployees.forEach(employee => {
                employeeConfigs[employee.id] = {
                    morningEntry: document.getElementById(`morning_entry_${employee.id}`).value,
                    morningExit: document.getElementById(`morning_exit_${employee.id}`).value,
                    afternoonEntry: document.getElementById(`afternoon_entry_${employee.id}`).value,
                    afternoonExit: document.getElementById(`afternoon_exit_${employee.id}`).value,
                    worksAfternoon: document.getElementById(`works_afternoon_${employee.id}`).checked,
                    saturdayEntry: document.getElementById(`sat_entry_${employee.id}`).value,
                    saturdayExit: document.getElementById(`sat_exit_${employee.id}`).value,
                    lunchDuration: parseInt(document.getElementById(`lunch_${employee.id}`).value),
                    saturdayLunch: 0
                };
            });

            processedEmployees.forEach(employee => {
                employee.days.forEach(day => {
                    if (!day.isSunday) {
                        day.stats = calculateDayStats(day.organized, employee.id);
                    }
                });
            });

            displayResults();
        }

        function displayResults() {
            if (processedEmployees.length === 0) {
                alert('No se pudieron procesar los datos.');
                return;
            }

            const maxDays = Math.max(...processedEmployees.map(emp => emp.days.length));

            const tableHead = document.getElementById('tableHead');
            let headerHTML = '<tr><th class="employee-name">Empleado</th>';
            for (let day = 1; day <= maxDays; day++) {
                headerHTML += `<th class="day-header">D${day}</th>`;
            }
            headerHTML += '<th>Horas Trabajadas</th><th>Horas Esperadas</th><th>Saldo</th><th>Tardanzas</th><th>H. Extra</th><th>Incompletos</th><th>Salidas Tempranas</th></tr>';
            tableHead.innerHTML = headerHTML;

            const tableBody = document.getElementById('tableBody');
            let bodyHTML = '';

            let totalHours = 0;
            let totalLateDays = 0;
            let totalOvertimeDays = 0;
            let totalDays = 0;
            let totalSaturdays = 0;
            let totalSundays = 0;
            let totalIncomplete = 0;
            let totalExpected = 0;
            let employeeEarlyExit = 0;

            processedEmployees.forEach(employee => {
                bodyHTML += `<tr><td class="employee-name">${employee.name}<br><small>${employee.department}</small></td>`;
                
                let employeeTotalHours = 0;
                let employeeTotalLate = 0;
                let employeeTotalOvertime = 0;
                let employeeTotalIncomplete = 0;
                let employeeSaturdays = 0;
                let employeeSundays = 0;
                let employeeExpectedHours = 0;

                employee.days.forEach((dayData, dayIndex) => {
                    const stats = dayData.stats;
                    
                    if (dayData.isSunday) {
                        bodyHTML += '<td class="sunday">DOMINGO <span class="sunday-indicator">D</span></td>';
                        employeeSundays++;
                        totalSundays++;
                    } else if (dayData.organized) {
                        const org = dayData.organized;
                        
                        employeeTotalHours += stats.hoursWorked;
                        if (stats.lateMinutes > 0) employeeTotalLate++;
                        if (stats.overtimeMinutes > 0) employeeTotalOvertime++;
                        if (stats.status === 'incompleto') employeeTotalIncomplete++;
                        if (org.isSaturday) employeeSaturdays++;
                        
                        let statusClass = '';
                        let statusIcon = '';
                        
                        switch (stats.status) {
                            case 'puntual':
                                statusClass = 'good';
                                statusIcon = '‚úÖ';
                                break;
                            case 'tarde':
                                statusClass = 'late';
                                statusIcon = 'üî¥';
                                totalLateDays++;
                                break;
                            case 'extra':
                                statusClass = 'overtime';
                                statusIcon = 'üü£';
                                totalOvertimeDays++;
                                break;
                            case 'tarde_extra':
                                statusClass = 'late';
                                statusIcon = '‚ö†Ô∏è';
                                totalLateDays++;
                                totalOvertimeDays++;
                                break;
                            case 'temprano':
                                statusClass = 'warning';
                                statusIcon = 'üü°';
                                break;
                            case 'incompleto':
                                statusClass = 'incomplete';
                                statusIcon = '‚ùå';
                                totalIncomplete++;
                                break;
                        }

                        let cellContent = `
                            <div class="time-cell">
                                <div><strong>${org.entry || '--'}</strong>‚Üí<strong>${org.exit || '--'}</strong></div>
                        `;
                        
                        if (org.afternoonEntry && org.afternoonEntry !== org.lunchEnd) {
                            cellContent += `<div><small>Tarde: ${org.afternoonEntry}</small></div>`;
                        }
                        
                        cellContent += `
                                <div class="${statusClass}">${minutesToTimeString(stats.hoursWorked)} ${statusIcon}</div>
                                ${stats.lateMinutes > 0 ? `<div class="late">+${minutesToTimeString(stats.lateMinutes)}</div>` : ''}
                                ${stats.overtimeMinutes > 0 ? `<div class="overtime">E+${stats.overtimeMinutes}m</div>` : ''}
                                ${org.isIncomplete ? `<div class="incomplete">Faltan: ${org.missingRecords.join(', ')}</div>` : ''}
                                ${org.isSaturday ? '<span class="saturday-indicator">S</span>' : ''}${stats.earlyExitMinutes > 0 ? `<div class="warning">-${minutesToTimeString(stats.earlyExitMinutes)}</div>` : ''}
                            </div>
                        `;
                        
                        const cellClass = org.isSaturday ? 'saturday' : '';
                        bodyHTML += `<td class="${cellClass}">${cellContent}</td>`;
                        totalDays++;
                    } else {
                        bodyHTML += '<td style="background: #f0f0f0;">--</td>';
                    }

                        employeeTotalHours += dayData.stats.hoursWorked;
                        employeeExpectedHours += dayData.stats.expectedMinutes || 0;
                });

                let saldo = employeeTotalHours - employeeExpectedHours;

                totalHours += employeeTotalHours;
                totalSaturdays += employeeSaturdays;
                totalHours += employeeTotalHours;
                totalExpected += employeeExpectedHours;  // üëà ahora s√≠ lo acumulas
                
                bodyHTML += `<td class="hours-worked"><strong>${minutesToTimeString(employeeTotalHours)}</strong></td>`;
                bodyHTML += `<td class="hours-expected"><strong>${minutesToTimeString(employeeExpectedHours)}</strong></td>`;
                bodyHTML += `<td class="${saldo >= 0 ? 'good' : 'late'}"><strong>${saldo >= 0 ? '+' : ''}${minutesToTimeString(saldo)}</strong></td>`;
                bodyHTML += `<td class="${employeeTotalLate > 0 ? 'late' : 'good'}">${employeeTotalLate}</td>`;
                bodyHTML += `<td class="${employeeTotalOvertime > 0 ? 'overtime' : 'good'}">${employeeTotalOvertime}</td>`;
                bodyHTML += `<td class="${employeeTotalIncomplete > 0 ? 'incomplete' : 'good'}">${employeeTotalIncomplete}</td>`;
                bodyHTML += `<td class="${employeeEarlyExit > 0 ? 'warning' : 'good'}">${minutesToTimeString(employeeEarlyExit)}</td>`;
                bodyHTML += '</tr>';
            });

            tableBody.innerHTML = bodyHTML;

            document.getElementById('summary').innerHTML = `
                <div class="summary-card">
                    <div class="summary-value">${processedEmployees.length}</div>
                    <div class="summary-label">Empleados</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${totalDays}</div>
                    <div class="summary-label">D√≠as Laborales</div>
                </div>
                <div class="summary-card" style="background: #fff8e1;">
                    <div class="summary-value" style="color: #ff9800;">${totalSaturdays}</div>
                    <div class="summary-label">S√°bados</div>
                </div>
                <div class="summary-card" style="background: #e8f5e8;">
                    <div class="summary-value" style="color: #4caf50;">${totalSundays}</div>
                    <div class="summary-label">Domingos</div>
                </div>
                <div class="summary-card" style="background: #ffebee;">
                    <div class="summary-value" style="color: #dc3545;">${totalLateDays}</div>
                    <div class="summary-label">Tardanzas</div>
                </div>
                <div class="summary-card" style="background: #f3e5f5;">
                    <div class="summary-value" style="color: #6f42c1;">${totalOvertimeDays}</div>
                    <div class="summary-label">Horas Extra</div>
                </div>
                <div class="summary-card" style="background: #fce4ec;">
                    <div class="summary-value" style="color: #e91e63;">${totalIncomplete}</div>
                    <div class="summary-label">Incompletos</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${minutesToTimeString(totalHours)}</div>
                    <div class="summary-label">Total Horas</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${minutesToTimeString(totalExpected)}</div>
                    <div class="summary-label">Horas Esperadas</div>
                </div>
                <div class="summary-card" style="background: #e8f5e9;">
                <div class="summary-value" style="color: ${totalHours - totalExpected >= 0 ? '#28a745' : '#dc3545'}">
                    ${totalHours - totalExpected >= 0 ? '+' : ''}${minutesToTimeString(totalHours - totalExpected)}
                </div>
                <div class="summary-label">Saldo de Horas</div>
                </div>

            `;

            document.getElementById('resultsSection').style.display = 'block';
        }

        function loadExampleData() {
            const example = `ID:		1090412874						Nombre:		YURLEY ALEXANDRA								Departamento:		Empresa										
05:5310:3213:5918:31	05:5011:4213:5614:59	05:5310:5313:5618:37	05:5510:5713:5817:33	05:5312:09		05:5010:4310:49	05:5910:5114:0118:27	05:5711:0313:5818:05	05:5610:4813:5718:15	05:5210:3313:5717:26	05:5312:07		05:5210:3813:5917:39	05:5110:3113:5818:01	10:2413:5917:18	05:5310:2114:0117:17	05:5210:3813:5917:20	05:5412:01		05:5310:4217:22	05:5610:2013:5817:41	10:2414:0017:23	05:5410:2414:0017:17	05:5510:2513:5517:26	05:4711:57		05:5510:2113:5917:27	05:5510:2314:0317:52	06:0410:2414:0317:54	05:5310:4310:4413:5817:59
ID:		13451767						Nombre:		GERMAN ENRIQUE								Departamento:		Empresa										
						06:3811:4814:1617:55	06:3411:3314:1217:32	06:4011:5914:1017:41	06:4211:4214:0717:30	06:4111:2714:3017:41	06:5310:31		06:3911:5314:1217:40	06:2911:3014:1517:22	06:3211:2914:1717:31	06:4011:3514:1217:28	06:4111:2914:1717:20	06:5910:48		06:4411:4314:1117:24	06:4811:4514:1817:21	06:3211:3614:0417:23	06:3411:3614:1217:20	06:4211:3414:1917:24	06:4210:34		06:3911:2914:1317:30	06:4211:5514:1717:39	06:3411:5211:5814:3317:40	06:3711:4414:1917:37`;
            
            document.getElementById('rawData').value = example;
        }

        function exportToCSV() {
            if (processedEmployees.length === 0) return;
            
            let csv = 'Empleado,ID,Departamento,Total_Horas,Dias_Tardanza,Dias_Horas_Extra,Dias_Incompletos,Sabados,Domingos\n';

            processedEmployees.forEach(employee => {
                let totalHours = 0;
                let lateDays = 0;
                let overtimeDays = 0;
                let incompleteDays = 0;
                let saturdays = 0;
                let sundays = 0;
                let employeeEarlyExit = 0;

                employee.days.forEach(dayData => {
                    employeeTotalHours += dayData.stats.hoursWorked;
                    employeeExpectedHours += dayData.stats.expectedMinutes || 0;
                    employeeEarlyExit += dayData.stats.earlyExitMinutes || 0;
                    employeeEarlyExit += stats.earlyExitMinutes || 0;

                });


                employee.days.forEach(day => {
                    if (day.isSunday) {
                        sundays++;
                    } else if (day.organized) {
                        totalHours += day.stats.hoursWorked;
                        if (day.stats.lateMinutes > 0) lateDays++;
                        if (day.stats.overtimeMinutes > 0) overtimeDays++;
                        if (day.stats.status === 'incompleto') incompleteDays++;
                        if (day.organized.isSaturday) saturdays++;
                    }
                });
                
                csv += `"${employee.name}","${employee.id}","${employee.department}",`;
                csv += `"${minutesToTimeString(totalHours)}",${lateDays},${overtimeDays},${incompleteDays},${saturdays},${sundays}\n`;
            });

            downloadCSV(csv, 'resumen_asistencia.csv');
        }

        function exportDetailedReport() {
            if (processedEmployees.length === 0) return;
            
            let csv = 'ID,Empleado,Departamento,Dia_Numero,Tipo_Dia,Entrada_Ma√±ana,Salida_Ma√±ana,Entrada_Tarde,Salida_Tarde,';
            csv += 'Horas_Trabajadas,Minutos_Tardanza,Minutos_Horas_Extra,Minutos_Salida_Temprana,Estado,Almuerzo_Inicio,Almuerzo_Fin,Registros_Faltantes,Todos_Los_Registros\n';

            processedEmployees.forEach(employee => {
                employee.days.forEach(day => {
                    const dayType = day.isSunday ? 'Domingo' : 
                                  (day.organized && day.organized.isSaturday ? 'S√°bado' : 'Laboral');
                    
                    if (day.isSunday) {
                        csv += `"${employee.id}","${employee.name}","${employee.department}",${day.dayNumber},"${dayType}",`;
                        csv += '"","","","","","","","","","domingo","","","",""' + '\n';
                    } else {
                        const org = day.organized;
                        const stats = day.stats;
                        const config = getEmployeeConfig(employee.id);
                        
                        // Determinar horarios esperados
                        let expectedMorningEntry = org.isSaturday ? config.saturdayEntry : config.morningEntry;
                        let expectedMorningExit = org.isSaturday ? config.saturdayExit : config.morningExit;
                        let expectedAfternoonEntry = config.worksAfternoon && !org.isSaturday ? config.afternoonEntry : '';
                        let expectedAfternoonExit = config.worksAfternoon && !org.isSaturday ? config.afternoonExit : '';
                        
                        csv += `"${employee.id}","${employee.name}","${employee.department}",${day.dayNumber},"${dayType}",`;
                        csv += `"${org.entry || ''}","${org.exit || ''}","${org.afternoonEntry || expectedAfternoonEntry}","${expectedAfternoonExit}",`;
                        csv += `"${minutesToTimeString(stats.hoursWorked)}","${minutesToTimeString(stats.lateMinutes)}","${minutesToTimeString(stats.overtimeMinutes)}","${minutesToTimeString(stats.earlyExitMinutes)}","${stats.status}",`;
                        csv += `"${org.lunchStart || ''}","${org.lunchEnd || ''}","${org.missingRecords ? org.missingRecords.join('; ') : ''}","${org.allTimes.join(' ')}"` + '\n';
                    }
                });
            });

            downloadCSV(csv, 'informe_completo_asistencia.csv');
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', filename);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        async function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF("landscape");

            doc.setFontSize(18);
            doc.text("üìä Informe de Asistencia", 14, 20);

            processedEmployees.forEach((employee, idx) => {
                const rows = employee.days.map(day => {
                    const org = day.organized || {};
                    const stats = day.stats;

                    return [
                        day.dayNumber,
                        day.isSunday ? "Domingo" : (org.isSaturday ? "S√°bado" : "Laboral"),
                        org.entry || "--",
                        org.lunchStart || "--",
                        org.lunchEnd || "--",
                        org.afternoonEntry || "--",
                        org.exit || "--",
                        stats ? stats.hoursWorked/60 + " h" : "0",
                        stats ? minutesToTimeString(stats.lateMinutes) : "0:00",
                        stats ? stats.overtimeMinutes + " min" : "0",
                        stats ? minutesToTimeString(stats.earlyExitMinutes) : "0:00",
                        stats ? stats.status : "--"
                    ];
                });

                doc.autoTable({
                    startY: idx === 0 ? 30 : doc.lastAutoTable.finalY + 10,
                    head: [["D√≠a", "Tipo", "Entrada", "Almuerzo Inicio", "Almuerzo Fin", "Entrada Tarde", "Salida", "Horas", "Tardanzas", "Extras", "Estado"]],
                    body: rows,
                    theme: "striped",
                    headStyles: { fillColor: [102, 126, 234] },
                    styles: { fontSize: 8 }
                });

                doc.text(`${employee.name} (${employee.department})`, 14, doc.lastAutoTable.finalY + 6);
            });

            doc.save("informe_asistencia.pdf");
        }

    </script>
</body>
</html>
